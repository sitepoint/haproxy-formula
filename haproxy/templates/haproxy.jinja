# HAProxy configuration
#
# **** DO NOT EDIT THIS FILE ****
#
# This file is managed by Salt.
# Any changes will be overwritten.


#------------------
# Global settings
#------------------
global
    log /dev/log local0
    log /dev/log local1 notice
{%- if salt['pillar.get']('haproxy:global:daemon', 'no') %}
    daemon
{%- endif %}
    user {{ salt['pillar.get']('haproxy:global:user', 'haproxy') }}
    group {{ salt['pillar.get']('haproxy:global:group', 'haproxy') }}
{%- if salt['pillar.get']('haproxy:global:chroot:enable', 'no') %}
    chroot {{ salt['pillar.get']('haproxy:global:chroot:path', '/tmp') }}
{%- endif %}
{%- if 'misc' in salt['pillar.get']('haproxy:global', {}) %}
  {%- for misc in salt['pillar.get']('haproxy:global:misc') %}
    {{ misc }}
  {%- endfor %}
{%- endif %}
{%- if salt['pillar.get']('haproxy:global:stats:enable', 'no') %}
    # Stats support is currently limited to socket mode
    stats socket {{
      salt['pillar.get'](
        'haproxy:global:stats:socketpath', '/tmp/ha_stats.sock'
      )
    }} {%-
      if 'options' in salt['pillar.get']('haproxy:global:stats', {})
    -%} {%-
        for option in salt['pillar.get']('haproxy:global:stats:options')
      %} {{ option }} {%- endfor -%}
    {%- endif %}
{% endif %}

#------------------
# Common defaults that all the 'listen' and 'backend' sections will
# use - if not designated in their block
#------------------
defaults
    log {{ salt['pillar.get']('haproxy:defaults:log') }}
    mode {{ salt['pillar.get']('haproxy:defaults:mode') }}
    retries {{ salt['pillar.get']('haproxy:defaults:retries') }}
    balance {{ salt['pillar.get']('haproxy:defaults:balance', 'roundrobin') }}
{%- if 'options' in salt['pillar.get']('haproxy:defaults', {}) %}
  {%- for option in salt['pillar.get']('haproxy:defaults:options') %}
    option {{ option }}
  {%- endfor %}
{%- endif %}
{%- if 'timeouts' in salt['pillar.get']('haproxy:defaults', {}) %}
  {%- for timeout in salt['pillar.get']('haproxy:defaults:timeouts') %}
    timeout {{ timeout }}
  {%- endfor %}
{%- endif %}
{%- if 'errorfiles' in salt['pillar.get']('haproxy:defaults', {}) %}
  {%- for error_code, error_file in salt['pillar.get']('haproxy:defaults:errorfiles').items()|sort %}
    errorfile {{ error_code }} {{ error_file }}
  {%- endfor %}
{% endif %}
{%- if 'resolvers' in salt['pillar.get']('haproxy', {}) %}

#------------------
# DNS resolvers
#------------------
{%- for resolver, resolver_opts in salt['pillar.get']('haproxy:resolvers').items()|sort %}
resolvers {{ resolver }}
  {%- for option in resolver_opts.get('options', ()) %}
    {{ option }}
  {%- endfor %}
{% endfor %}
{%- endif %}
{%- if 'userlist' in salt['pillar.get']('haproxy', {}) %}

#------------------
# User lists
#------------------
{%- for userlist in salt['pillar.get']('haproxy:userlist', {}).items()|sort %}
userlist {{ userlist[0] }}
  {%- if 'users' in userlist[1] %}
      {%- for user in userlist[1].users %}
    user {{ user }}
      {%- endfor %}
  {%- endif %}
  {%- if 'groups' in userlist[1] %}
      {%- for group in userlist[1].groups %}
    group {{ group }}
      {%- endfor %}
  {%- endif %}
{% endfor %}
{%- endif %}
{%- if 'listens' in salt['pillar.get']('haproxy', {}) %}

#------------------
# Listen instances
#------------------
{%- for listener, listener_config in salt['pillar.get']('haproxy:listens', {}).items()|sort %}
listen {{ listener_config.name|default(listener) }}
    {%- if 'bind' in listener_config %}
      {%- if listener_config.bind[1] is defined and listener_config.bind[1]|length > 1 %}
        {%- for socket in listener_config.bind %}
    bind {{ socket }}
        {%- endfor %}
      {%- elif listener_config.bind[0]|length > 1 %}
    bind {{ listener_config.bind[0] }}
      {%- else %}
    bind {{ listener_config.bind }}
      {%- endif %}
    {%- endif %}
    {%- if 'acls' in listener_config %}
      {%- for acl in listener_config.acls %}
    acl {{ acl }}
      {%- endfor %}
    {%- endif %}
    {%- if 'http_request' in listener_config %}
      {%- for http_request in listener_config.http_request %}
    http-request {{ http_request }}
      {%- endfor %}
    {%- endif %}
    {%- if 'http_response' in listener_config %}
      {%- for http_response in listener_config.http_response %}
    http-response {{ http_response }}
      {%- endfor %}
    {%- endif %}
    {%- if 'stick_table' in listener_config %}
      {%- for stick_table in listener_config.stick_table %}
    stick-table {{ stick_table }}
      {%- endfor %}
    {%- endif %}
    {%- if 'redirects' in listener_config %}
      {%- for front_redirect in listener_config.redirects %}
    redirect {{ front_redirect }}
      {%- endfor %}
    {%- endif %}
    {%- if 'reqadd' in listener_config %}
      {%- for reqadd in listener_config.reqadd %}
    reqadd {{ reqadd }}
      {%- endfor %}
    {%- endif %}
    {%- if 'monitor_uri' in listener_config %}
    monitor-uri {{ listener_config.monitor_uri }}
    {%- endif %}
    {%- if 'monitor' in listener_config %}
      {%- for monitor in listener_config.monitor %}
    monitor {{ monitor }}
      {%- endfor %}
    {%- endif %}
    {%- if 'errorfiles' in listener_config %}
      {%- for error_code, error_file in listener_config.get('errorfiles').items()|sort %}
    errorfile {{ error_code }} {{ error_file }}
      {%- endfor %}
    {%- endif %}
    {%- if 'default_backend' in listener_config %}
    default_backend {{ listener_config.default_backend }}
    {%- endif %}
    {%- if 'use_backends' in listener_config %}
      {%- for use_backend in listener_config.use_backendsi %}
    use_backend {{ use_backend }}
      {%- endfor %}
    {%- endif %}
    {%- if 'balance' in listener_config %}
    balance {{ listener_config.balance }}
    {%- endif %}
    {%- if 'options' in listener_config %}
      {%- for option in listener_config.options %}
    option {{ option }}
      {%- endfor %}
    {%- endif %}
    {%- if 'timeouts' in listener_config %}
      {%- for timeout in listener_config.timeouts %}
    timeout {{ timeout }}
      {%- endfor %}
    {%- endif %}
    {%- if 'cookie' in listener_config %}
    cookie {{ listener_config.cookie }}
    {% endif %}
    {%- if 'stats' in listener_config %}
      {%- for option, value in listener_config.stats.items()|sort %}
        {%- if option == 'enable' and value %}
    stats enable
        {%- elif option == 'hide_version' and value %}
    stats hide-version
        {%- else %}
    stats {{ option }} {{ value }}
        {%- endif %}
      {%- endfor %}
    {%- endif %}
    {%- if 'appsession' in listener_config %}
    appsession {%- for option in listener_config.appsession %}  {{ option }}  {%- endfor %}
    {%- endif %}
    {%- if 'defaultserver' in listener_config %}
    default-server {%- for option, value in listener_config.defaultserver.items()|sort %} {{ ' '.join((option, value|string, '')) }} {%- endfor %}
    {%- endif %}
    {%- if 'servers' in listener_config and listener_config.servers is iterable() %}
      {%- for server, server_config in listener_config.servers.items()|sort %}
    server {{ server_config.name|default(server) }} {{ server_config.host }}:{{ server_config.port }} {{ server_config.check }}
      {%- endfor %}
    {%- endif -%}
    {%- if 'mine_servers_module' in listener_config and 'mine_servers' in listener_config %}
      {%- set match_type = listener_config.mine_servers_match_type|default('glob') %}
      {%- for server, address in salt['mine.get'](listener_config.mine_servers, listener_config.mine_servers_module, match_type).items()|sort %}
      {%- set extras = listener_config.mine_servers_extras|default({}) %}
    server {{ server }} {{ address }}:{{ extras.port|default('80') }} {{ extras.check|default('') }} {{ extras.extra|default('') }}
      {%- endfor %}
    {%- endif %}
  {% endfor %}
{%- endif %}
{%- if 'frontends' in salt['pillar.get']('haproxy', {}) %}

#------------------
# Frontend instances
#------------------
  {%- for frontend, frontend_config in salt['pillar.get']('haproxy:frontends', {}).items()|sort %}
frontend {{ frontend_config.name|default(frontend) }}
    {%- if 'bind' in frontend_config %}
      {%- if frontend_config.bind[1] is defined and frontend_config.bind[1]|length > 1 %}
        {%- for socket in frontend_config.bind %}
    bind {{ socket }}
        {%- endfor %}
      {%- elif frontend_config.bind[0]|length > 1 %}
    bind {{ frontend_config.bind[0] }}
      {%- else %}
    bind {{ frontend_config.bind }}
      {%- endif %}
    {%- endif %}
    {%- if 'options' in frontend_config %}
      {%- for option in frontend_config.options %}
    {{ option }}
      {%- endfor %}
    {%- endif %}
    {%- if 'timeouts' in frontend_config %}
      {%- for timeout in frontend_config.timeouts %}
    timeout {{ timeout }}
      {%- endfor %}
    {%- endif %}
    {%- if 'acls' in frontend_config %}
      {%- for acl in frontend_config.acls %}
    acl {{ acl }}
      {%- endfor %}
    {%- endif %}
    {%- if 'rspirep' in frontend_config %}
      {%- for rspirep in frontend_config.rspirep %}
    rspirep {{ rspirep }}
      {%- endfor %}
    {%- endif %}
    {%- if 'http_request' in frontend_config %}
      {%- for http_request in frontend_config.http_request %}
    http-request {{ http_request }}
      {%- endfor %}
    {%- endif %}
    {%- if 'http_response' in frontend_config %}
      {%- for http_response in frontend_config.http_response %}
    http-response {{ http_response }}
      {%- endfor %}
    {%- endif %}
    {%- if 'stick_table' in frontend_config %}
      {%- for stick_table in frontend_config.stick_table %}
    stick-table {{ stick_table }}
      {%- endfor %}
    {%- endif %}
    {%- if 'reqirep' in frontend_config %}
      {%- for reqirep in frontend_config.reqirep %}
    reqirep {{ reqirep }}
      {%- endfor %}
    {%- endif %}
    {%- if 'redirects' in frontend_config %}
      {%- for front_redirect in frontend_config.redirects %}
    redirect {{ front_redirect }}
      {%- endfor %}
    {%- endif %}
    {%- if 'reqadd' in frontend_config %}
      {%- for reqadd in frontend_config.reqadd %}
    reqadd {{ reqadd }}
      {%- endfor %}
    {%- endif %}
    {%- if 'monitor_uri' in frontend_config %}
    monitor-uri {{ frontend_config.monitor_uri }}
    {%- endif %}
    {%- if 'monitor' in frontend_config %}
      {%- for monitor in frontend_config.monitor %}
    monitor {{ monitor }}
      {%- endfor %}
    {%- endif %}
    {%- if 'use_backends' in frontend_config %}
      {%- for use_backend in frontend_config.use_backends %}
    use_backend {{ use_backend }}
      {%- endfor %}
    {%- endif %}
    {%- if 'default_backend' in frontend_config %}
    default_backend {{ frontend_config.default_backend }}
    {%- endif %}
  {% endfor %}
{%- endif %}
{%- if 'backends' in salt['pillar.get']('haproxy', {}) %}

#------------------
# Backend instances
#------------------
  {%- for backend, backend_config in salt['pillar.get']('haproxy:backends', {}).items()|sort %}
backend {{ backend_config.name|default(backend) }}
    {%- if 'balance' in backend_config %}
    balance {{ backend_config.balance }}
    {%- endif %}
    {%- if 'options' in backend_config %}
      {%- for option in backend_config.options %}
    option {{ option }}
      {%- endfor %}
    {%- endif %}
    {%- if 'timeouts' in backend_config %}
      {%- for timeout in backend_config.timeouts %}
    timeout {{ timeout }}
      {%- endfor %}
    {%- endif %}
    {%- if 'http_check' in backend_config %}
      {%- for h_c in backend_config.http_check %}
    http-check {{ h_c }}
      {%- endfor %}
    {%- endif %}
    {%- if 'cookie' in backend_config %}
    cookie {{ backend_config.cookie }}
    {%- endif %}
    {%- if 'stats' in backend_config %}
      {%- for option, value in backend_config.stats.items()|sort %}
        {%- if option == 'enable' and value %}
    stats enable
        {%- else %}
    stats {{ option }} {{ value }}
        {%- endif %}
      {%- endfor %}
    {%- endif %}
    {%- if 'acls' in backend_config %}
      {%- for acl in backend_config.acls %}
    acl {{ acl }}
      {%- endfor %}
    {%- endif %}
    {%- if 'http_request' in backend_config %}
      {%- for http_request in backend_config.http_request %}
    http-request {{ http_request }}
      {%- endfor %}
    {%- endif %}
    {%- if 'http_response' in backend_config %}
      {%- for http_response in backend_config.http_response %}
    http-response {{ http_response }}
      {%- endfor %}
    {%- endif %}
    {%- if 'stick_table' in backend_config %}
      {%- for stick_table in backend_config.stick_table %}
    stick-table {{ stick_table }}
      {%- endfor %}
    {%- endif %}
    {%- if 'reqirep' in backend_config %}
      {%- for reqirep in backend_config.reqirep %}
    reqirep {{ reqirep }}
      {%- endfor %}
    {%- endif %}
    {%- if 'rspirep' in backend_config %}
      {%- for rspirep in backend_config.rspirep %}
    rspirep {{ rspirep }}
      {%- endfor %}
    {%- endif %}
    {%- if 'redirects' in backend_config %}
      {%- for redirect in backend_config.redirects %}
    redirect {{ redirect }}
      {%- endfor %}
    {%- endif %}
    {%- if 'hash_type' in backend_config %}
    hash-type {{ backend_config.hash_type }}
    {%- endif %}
    {%- if 'source' in backend_config %}
    source {{ backend_config.source }}
    {%- endif %}
    {%- if 'defaultserver' in backend_config %}
    default-server {%- for option, value in backend_config.defaultserver.items()|sort %} {{ ' '.join((option, value|string, '')) }} {%- endfor %}
    {%- endif %}
    {%- if 'servers' in backend_config and backend_config.servers is iterable() %}
      {%- for server, server_config in backend_config.servers.items()|sort %}
    server {{ server_config.name|default(server) }} {{ server_config.host }}:{{ server_config.port }} {{ server_config.check }} {{ server_config.extra|default('') }}
      {%- endfor %}
    {%- endif %}
    {%- if 'mine_servers_module' in backend_config and 'mine_servers' in backend_config %}
      {%- set match_type = backend_config.mine_servers_match_type|default('glob') %}
      {%- for server, address in salt['mine.get'](backend_config.mine_servers, backend_config.mine_servers_module, match_type).items()|sort %}
      {%- set extras = backend_config.mine_servers_extras|default({}) %}
    server {{ server }} {{ address }}:{{ extras.port|default('80') }} {{ extras.check|default('') }} {{ extras.extra|default('') }}
      {%- endfor %}
    {%- endif %}
  {% endfor %}
{%- endif %}
